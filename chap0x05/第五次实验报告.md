# 第五次实验报告 #

## 实验目的 ##

掌握web服务器搭建的相关知识

## 实验环境 ##

- windows10
- virtualbox
- ubuntu 20.04 Server 64bit
- Nginx
- VeryNginx
- Wordpress4.7
- DVWA

## 一、实验环境搭建 ##



 ```bash
#对主机hosts文件作出如下更改： 
192.168.43.3 vn.sec.cuc.edu.cn
192.168.43.3 dvwa.sec.cuc.edu.cn
192.168.43.3 wp.sec.cuc.edu.cn
 ```

```bash
#安装php和mysql:
sudo apt install php-fpm php-mysql php-curl php-gd php-intl php-mbstring php-soap php-xml php-xmlrpc php-zip

sudo apt -y install mysql-server
```

### 2.安装Nginx ###

```bash
sudo apt update
sudo apt -y install nginx
sudo nginx -t
#完成安装

sudo sed -i 's/80/8080/' /etc/nginx/sites-available/default
sudo systemtcl reload nginx
#为了避免nginx和veryngin占用同一窗口，改其80端口为8080
```

### 3.安装VeryNginx ###

```bash
wget https://github.com/alexazhou/VeryNginx/archive/master.zip
unzip master.zip
cd VeryNginx-master

sudo python3 install.py install
#根据报错安装以下包：

sudo apt-get install zlib1g-dev

sudo apt-get update 
sudo apt-get install libpcre3 libpcre3-dev

sudo apt install gcc
sudo apt install make
sudo apt install libssl-dev
```

### 4.修改配置文件 ###

```bash
#进入到文件中进行修改：
sudo vim /opt/verynginx/openresty/nginx/conf/nginx.conf

#作出更改的地方有:
user www-data
server listen 8006

sudo adduser nginx

#添加进程权限
chmod -R 777 /opt/verynginx/verynginx/configs

#建立软连接，可以通过`sudo verynginx`直接启动
sudo ln -s /opt/verynginx/openresty/nginx/sbin/nginx /usr/sbin/verynginx


```

### 5.安装wordpress ###



#### 数据库创建 ####

```bash

sudo mysql -u root -p


mysql> CREATE USER 'wordpress'@'localhost' IDENTIFIED BY 'wordpress';
mysql> CREATE DATABASE wordpress_db;
mysql> GRANT ALL ON wordpress_db.* TO 'wordpress'@'localhost';

```

#### wordpress ####

```bash
# 创建目录
sudo mkdir -p /var/www/wordpress/public/

# 修改属主为www-data
sudo chown -R www-data:www-data /var/www/wordpress/public

#下载并解压WorePress
wget https://wordpress.org/wordpress-4.7.zip
unzip wordpress-4.7.zip
sudo cp -r wordpress/* /var/www/html/wordpress/

#拷贝配置文件
cd /var/www/html/wordpress/
sudo cp wp-config-sample.php wp-config.php

#获取个人密钥
curl -s https://api.wordpress.org/secret-key/1.1/salt/

#修改wp-config.php中的配置
sudo vim /var/www/html/wordpress/wp-config.php

#修改database
define('AUTH_KEY',         'VALUES COPIED FROM THE COMMAND LINE');
define('SECURE_AUTH_KEY',  'VALUES COPIED FROM THE COMMAND LINE');
define('LOGGED_IN_KEY',    'VALUES COPIED FROM THE COMMAND LINE');
define('NONCE_KEY',        'VALUES COPIED FROM THE COMMAND LINE');
define('AUTH_SALT',        'VALUES COPIED FROM THE COMMAND LINE');
define('SECURE_AUTH_SALT', 'VALUES COPIED FROM THE COMMAND LINE');
define('LOGGED_IN_SALT',   'VALUES COPIED FROM THE COMMAND LINE');
define('NONCE_SALT',       'VALUES COPIED FROM THE COMMAND LINE');
define( 'DB_NAME', 'wordpress' );
/** MySQL database username */
define( 'DB_USER', 'wordpressuser' );
/** MySQL database password */
define( 'DB_PASSWORD', 'password' );

define( 'FS_METHOD', 'direct' );

#修改配置文件
sudo vim /etc/nginx/sites-available/wp.sec.cuc.edu.cn
server {
    listen 8081;
    server_name wp.sec.cuc.edu.cn;
    root /var/www/html/wordpress/;
    index index.php index.html index.htm index.nginx-debian.html;
    location / {
        #try_files $uri $uri/ =404;
        try_files $uri $uri/ /index.php$is_args$args
    }
    location = /favicon.ico { log_not_found off;access_log off; }
    location = /robots.txt { log_not_found off; access_log off; allow all; }
    location ~* \.(css|gif|ico|jpeg|jpg|js|png)$ {
        expires max;
        log_not_found off;
    }
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
     }
}

sudo ln -s /etc/nginx/sites-available/wp.sec.cuc.edu.cn /etc/nginx/sites-enabled/
sudo unlink /etc/nginx/sites-enabled/default

#确认
sudo nginx -t
sudo systemctl restart nginx
```

#### 访问VeryNginx ####

![verynginx](/img/verynginx.png)

### 6.DVWA ###

```bash
#DVWA下载
git clone https://github.com/ethicalhack3r/DVWA
cp DVWA/config/config.inc.php.dist DVWA/config/config.inc.php 
sudo cp -a DVWA/. /var/www/dvwa.sec.cuc.edu.cn
sudo chown www-data:www-data  /var/www/dvwa.sec.cuc.edu.cn

# 编辑配置文件
sudo tee /etc/nginx/sites-available/dvwa.sec.cuc.edu.cn <<EOF
server {
    listen 8082;
    server_name dvwa.sec.cuc.edu.cn www.dvwa.sec.cuc.edu.cn;
    root /var/www/dvwa.sec.cuc.edu.cn;
    index index.html index.htm index.php;
    location / {
        #try_files $uri $uri/ =404;
       try_files $uri $uri/ /index.php$is_args$args;
    }
    location = /favicon.ico { log_not_found off; access_log off; }
    location = /robots.txt { log_not_found off; access_log off; allow all; }
    location ~* \.(css|gif|ico|jpeg|jpg|js|png)$ {
        expires max;
        log_not_found off;
    }
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
     }
    location ~ /\.ht {
        deny all;
    }
}
EOF

# 创建数据库
sudo mysql
CREATE DATABASE dvwa DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci;
CREATE USER 'dvwa'@'localhost' IDENTIFIED BY 'password';
GRANT ALL ON dvwa.* TO 'dvwa'@'localhost';
exit

# 软链接
sudo ln -s /etc/nginx/sites-available/dvwa.sec.cuc.edu.cn /etc/nginx/sites-enabled/

sudo nginx -t
sudo systemctl reload nginx
```
#### 访问DVWA ####
![dvma](/img/DVWA.png)

### 7.相关加固要求的实现 ###

#### （1）使用IP地址方式均无法访问上述任意站点，并向访客展示自定义的友好错误提示信息页面-1 ####

- matcher
<br>
![matcher1](/img/matcher1.png)

- response
<br>
![response2](/img/response1.png)

- filter
<br>
![filter1](/img/filter1/png)

#### （2）Damn Vulnerable Web Application (DVWA)只允许白名单上的访客来源IP，其他来源的IP访问均向访客展示自定义的友好错误提示信息页面-2 ####

- matcher

- response 

- filter


#### （3）在不升级wordpress版本的情况下，通过定制VeryNginx的访问控制策略规则，热修复WordPress < 4.7.1 - Username Enumeration ####

- matcher

- response

- filter


#### （4）通过配置VeryNginx的Filter规则实现对Damn Vulnerable Web Application (DVWA)的SQL注入实验在低安全等级条件下进行防护 ####

- matcher

- response

- filter



### 8.verynginx配置要求 ###

#### (1)VeryNginx的Web管理页面仅允许白名单上的访客来源IP，其他来源的IP访问均向访客展示自定义的友好错误提示信息页面-3 ####

- matcher

- response

- filter


#### (2)通过定制VeryNginx的访问控制策略规则实现: ####

- 限制DVWA站点的单IP访问速率为每秒请求数 < 50 
- 限制Wordpress站点的单IP访问速率为每秒请求数 < 20 
- 超过访问频率限制的请求直接返回自定义错误提示信息页面-4 



- 禁止curl访问 




## 错误与总结 ##
### 在进行准备阶段，对程序的update以及install的时候因为权限问题无法执行 ###
- 报错语句：
```bash
E：Unable to lock directory /var/lib/apt/lists/(13: permission denied)
```
- 解决方法：使用该语句kill掉进程。
```bash
sudo fuser -vki /var/lib/apt/lists/lock 

```
### 无法更新源的问题 ###

安装的过程中出现问题：Enale to locate package 

解决方法：在vim文件中替换清华的镜像源。
```bash
#在vim /etc/apt/sources.list中：

deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ trusty main restricted universe multiverse
#deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ trusty main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ trusty-updates main restricted universe multiverse
#deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ trusty-updates main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ trusty-backports main restricted universe multiverse
#deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ trusty-backports main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ trusty-security main restricted universe multiverse

```



## 参考资料 ##
- [unbuntu无法安装yum解决](https://blog.csdn.net/weixin_48179190/article/details/107706516)
- [Linux常见错误 “cp: omitting directory”解决办法](https://blog.csdn.net/qq_27278957/article/details/81188973)
- [VeryNginx](https://github.com/alexazhou/VeryNginx/blob/master/readme_zh.md)
- [开始使用 VeryNginx](http://www.udpwork.com/item/15995.html)-[nginx-fails-to-stop-and-nginx-pid-is-missing](https://serverfault.com/questions/565339/nginx-fails-to-stop-and-nginx-pid-is-missing)
- 《Linux服务器搭建实战详解》
- [trouble shooting](https://github.com/alexazhou/VeryNginx/wiki/Trouble-Shooting)